# This is Simplifai's default .NET build and push to ACR workflow template
# You might need to adjust the variables to fit your project

name: Build .NET app and deploy to AKS

on:
  workflow_dispatch:
  push:
    branches: [ $default-branch ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
      - '.github/**'


env:
  ACR_NAME_DEV: ${{ vars.ACR_DEV }} # Organization variable
  ACR_NAME_PROD: ${{ vars.ACR_PROD }} # Organization variable
  APP_VERSION: v1.${{ github.run_number }}
  CONTAINER_NAME: 'demo/worker'
  CS_PROJ_PATH: './src/worker/worker.csproj'
  WORKING_DIR: './src/worker/'

jobs:
  build:
    if: ${{ github.actor != 'dependabot[bot]' }} # skip dependabot
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    strategy:
      matrix:
        dotnet-version: [ '8.0.x' ]

    steps:
    - name: ‚è¨ Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
    
    - name: üì¶ Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        # Look to see if there is a cache hit for the corresponding requirements file
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget

    - name: üèóÔ∏è Build .NET
      run: dotnet build
      working-directory: ${{ env.WORKING_DIR }}

    - name: üè∑Ô∏è create version tag
      run: |
        echo current version is ${{ env.APP_VERSION }}
        git config user.name "GitHub Actions"
        git config user.email "github-actions@users.noreply.github.com"
        git tag -a ${{ env.APP_VERSION }} -m "${{ github.event.head_commit.message }}"
        git push origin ${{ env.APP_VERSION }}

  # calls a central workflow to build and push the docker image  
  deploy:
    permissions:
      contents: read
      id-token: write
    needs: [build]
    uses: simplifai-ai/studio-workflows/.github/workflows/studio-helm-release.yaml@main
    secrets: inherit

